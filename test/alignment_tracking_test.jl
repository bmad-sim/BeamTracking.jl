using BeamTracking, Test

vb1 = [0.1, 0.02, 0.3+1e-15, 0.04, 0.5, 1.0]
vb1 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]


t1 = [0.1  0.02  0.3  0.04   0.5  0.3
      0.5  0.06  0.6  0.07  -0.4 -0.1]


vs1 = [0.1  0.02  0.3  0.04   0.5  0.3
      0.5  0.06  0.6  0.07  -0.4 -0.1]

vs_enter = [-0.3165959808234934 0.04754745605909551 -0.18236536347877394 0.05158049064876938 -0.09246402200390502 0.3
            0.12459790840631677 0.08022476563661293 0.1335585205366428 0.0765632835356387 -1.0072270672604062 -0.1]

vs_exit = [0.4642308021396079 -0.007202272574320878 0.7750188504234871 0.027587793397562316 1.1046174611916189 0.3
          0.8241548285801633 0.039944172668196574 1.0565996679665617 0.06281213996499757 0.21752162316101464 -0.1]


m1 = [
  0.9997499770794925 0.5866010204862417 0.030196943370503864 0.01771798769973302 0.0 0.0
  0.0 0.9993441318056852 0.0 0.029994000439983615 0.0 0.020289557983054828; 
 -0.03000150030254883 -0.017603311925051535 0.9995940132331024 0.5865095090548349 0.0 0.0
  0.0 -0.03018939465051038 0.0 0.9995000566637778 0.0 0.009393464735686361
 -0.020002667093402426 -0.011736519328275472 -0.010002333746735214 -0.005868846529228098 1.0 0.0
  0.0 0.0 0.0 0.0 0.0 1.0]

m2 = [
  0.9997499770794925 -0.5996250016312417 -0.030001500302548834 0.01799414861744492 0.0 0.0
  0.0 0.9993441318056852 0.0 -0.030189394650510383 0.0 -0.019997666768331163
  0.030196943370503868 -0.01811137047553758 0.9995940132331024 -0.599531458421649 0.0 0.0
  0.0 0.02999400043998362 0.0 0.9995000566637778 0.0 -0.009999833334166661
  0.020294631294188712 -0.012172211654790323 0.009395813528561451 -0.00563537367497487 1.0 0.0
  0.0 0.0 0.0 0.0 0.0 1.0]

# track_alignment_straight! args: (x_off, y_off, z_off, x_rot, y_rot, tilt, ele_orient, L)
# track_alignment_bend! args: (x_off, y_off, z_off, x_rot, y_rot, tilt, g_ref, tilt_ref, ele_orient, L)

@testset "AlignmentKernel" begin
  # bend tests

  bunch = Bunch(copy(vb1))
 # BeamTracking.launch!(bunch.coords, KernelCall(BeamTracking.track_alignment_bend_entering!,
 #                                           (0., 0., 0., 0.00, -0.00, 0.00, pi/2, 0.0, +1, 2.0)))
 # println(bunch.coords.v)
 # @test bunch.coords.v ≈ vs_enter


  # Straight tests

  bunch = Bunch(copy(vs1))
  BeamTracking.launch!(bunch.coords, KernelCall(BeamTracking.track_alignment_straight_entering!,
                                                      (0.4, 0.5, 0.6, 0.01, -0.02, 0.03, +1, 2.0)))
  @test bunch.coords.v ≈ vs_enter

  bunch = Bunch(copy(vs1))
  BeamTracking.launch!(bunch.coords, KernelCall(BeamTracking.track_alignment_straight_exiting!,
                                                      (0.4, 0.5, 0.6, 0.01, -0.02, 0.03, +1, 3.0)))
  @test bunch.coords.v ≈ vs_exit

  test_matrix(m1, KernelCall(BeamTracking.track_alignment_straight_entering!, 
                                                      (0.4, 0.5, 0.6, 0.01, -0.02, 0.03, +1, 2.0)))
  test_matrix(m2, KernelCall(BeamTracking.track_alignment_straight_exiting!, 
                                                      (0.4, 0.5, 0.6, 0.01, -0.02, 0.03, +1, 3.0)))
end

