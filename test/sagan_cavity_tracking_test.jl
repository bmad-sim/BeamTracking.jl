import BeamTracking as BT

vb1 = [0.1, 0.02, 0.3, 0.04, 0.5, 1.0]
out1 = [0.1255712996055849 0.021130700478369572 0.3418736223975687 0.040789100229105604 0.505927539334479 0.7560175379085637]
out2 = [0.12472572480619534 0.019299195161732233 0.3461750920504792 0.03772714722206612 0.5058059437930548 0.7554378514920698]

m1out = [0.991226582338527 1.945438551417902 0.034270453003413776 0.0481416712531441 -5.7613772817054056e-5 0.0003774751968274578; -0.00813196345087847 0.8998757858182833 0.011989230131621792 0.031258787069402265 1.7360406721819756e-6 -1.327835179830701e-5; -0.008658874478463016 -0.035593158240302875 1.0079114165451852 1.9538147272396487 0.00012467793281137427 -0.0008282411028661737; 0.011999649076356023 -0.007733777633836706 0.007870120068572009 0.9159314760996143 6.52652275342113e-7 -4.557732727845935e-6; 1.204398577961017e-7 0.00040991271594663706 3.369089129708579e-6 -0.0008129335063434815 0.9987159126847555 0.018568360816389934; -2.723467916092474e-7 -2.061427149691029e-5 -2.042600936708273e-7 4.1228542994042585e-5 -0.18723840217031384 0.9059817556172876]



m2out = [0.9690958700629988 1.9454006438640021 0.017517712074800358 0.026066904450224162 -2.637764598683018e-5 0.00020410860260282722; -0.005531100827201287 0.9260219727265299 0.006278551587978387 0.01681122484328427 1.0084655854140437e-5 -1.0663428022519371e-6; -0.004416502802481768 -0.01783115417523026 0.9777493040723166 1.9508899336387555 5.5142669140447805e-5 -0.00042716481805788495; 0.006309160940297908 -0.004150855790860934 0.002860389895862436 0.9345387258963115 -1.9486504708562716e-5 -6.421643263701643e-6; -2.9082509933145476e-6 0.00021282966396674242 6.604384561233256e-6 -0.000423156208271126 0.9986647632724044 0.01854251708208316; 9.922722720281393e-6 4.8014123649368945e-6 -2.0131115697102087e-5 -9.671324815522965e-6 -0.187127723723515 0.9060350692247849]

L = 2.0
mass = 1e6
q = -2
E0 = 1e7
dE = 1e6
E1 = E0 + dE
p_over_q = sqrt(E1^2 - mass^2) / (C_LIGHT * q)
t_ref = 0.1 / C_LIGHT
order = SA[0, 1, 2]
Bn = SA[0.01, 0.0001, 0.002] * p_over_q
Bs = SA[0.0, 0.0002, 0.003] * p_over_q
voltage = 4e5
rf_omega = 1e9
t_phi0 = 0.1
a = 0.1

# sagan_cavity_thin!(i, coords::Coords, radiation_damping_on, 
#                                      mass, q, E0_ref, dE_ref,
#                                      t_ref, m_order, BnL, BsL, a, q_voltage, rf_omega, t_phi0, L)

# sagan_cavity_thick!(i, coords::Coords, radiation_damping_on, traveling_wave, 
#              mass, q, E0_ref, dE_ref, t_ref, n_cell, m_order, Bn, Bs, 
#              a, q_voltage, rf_omega, t_phi0, L_active, L)



@testset "SaganCavityKernel" begin
  args = (true, mass, q, E0, dE, t_ref, order, Bn*L, Bs*L, a, q*voltage, rf_omega, t_phi0, L)
  bunch = Bunch(copy(vb1))
  BT.launch!(bunch.coords, KernelCall(BT.sagan_cavity_thin!, args))
  @test bunch.coords.v ≈ out1
  @test bunch.t_ref ≈ 0
  test_matrix(m1out, KernelCall(BT.sagan_cavity_thin!, args))

  args = (true, false, mass, q, E0, dE, t_ref, 2.0, order, Bn, Bs, a, q*voltage, rf_omega, t_phi0, L/2, L)
  bunch = Bunch(copy(vb1))
  BT.launch!(bunch.coords, KernelCall(BT.sagan_cavity_thick!, args))
  @test bunch.coords.v ≈ out2
  test_matrix(m2out, KernelCall(BT.sagan_cavity_thick!, args))
end
