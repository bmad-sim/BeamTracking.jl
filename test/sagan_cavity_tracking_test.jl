import BeamTracking as BT

vb1 = [0.1, 0.02, 0.3, 0.04, 0.5, 1.0]
out1 = [0.1255712996055849 0.021130700478369572 0.3418736223975687 0.040789100229105604 0.505927539334479 0.7560175379085637]
out2 = [0.12472572480619534 0.019299195161732233 0.3461750920504792 0.03772714722206612 0.5058059437930548 0.7554378514920698]

m1out = [0.991226582338527 1.9454385514179018 0.034270453003413776 0.0481416712531441 -5.7613772817054056e-5 0.0003774751968274579; -0.008131963450878467 0.8998757858182828 0.011989230131621781 0.03125878706940225 1.7360406721819602e-6 -1.3278351798307171e-5; -0.00865887447846302 -0.035593158240302875 1.0079114165451852 1.9538147272396487 0.00012467793281137433 -0.0008282411028661737; 0.01199964907635602 -0.007733777633836701 0.007870120068572007 0.9159314760996139 6.526522753421397e-7 -4.557732727845457e-6; 1.2043985779611208e-7 0.00040991271594663565 3.3690891297085625e-6 -0.0008129335063434823 0.9987159126847555 0.018568360816389934; -2.7234679160849484e-7 -2.061427149704908e-5 -2.0426009367234974e-7 4.122854299397503e-5 -0.18723840217031384 0.9059817556172876]



m2out = [0.6524131100339847 1.6887889719953346 0.7831786124041606 0.6316413604970078 -0.00047617796518395754 0.002829937668836005; -0.2216904694459043 0.565609717157622 0.6361444243318084 0.7236027898017308 0.002215606139437425 -0.0139914756089747; 0.562844488640398 0.19212735361430322 1.469001468386509 2.238385796473843 0.006061314258716868 -0.04728939498779113; 0.6421105408268521 0.5121617157471546 0.6299428691899097 1.4659992080518174 -0.0015025050325199478 -0.005619173703188645; -0.020630310240985685 0.002309793762079719 -0.009734993277053898 -0.05064120347785151 0.9984521254680477 0.02003411259209101; 0.00046406529329931934 0.0001859677597945453 -0.002168703875428626 -0.0010287131300274668 -0.18715816735598548 0.9060527341101654]

L = 2.0
mass = 1e6
q = -2
E0 = 1e7
dE = 1e6
E1 = E0 + dE
p_over_q = sqrt(E1^2 - mass^2) / (C_LIGHT * q)
t_ref = 0.1 / C_LIGHT
order = [1, 2]
Bsol = 0.01 * p_over_q
Bn =[0.0001, 0.002] * p_over_q
Bs = [0.0002, 0.003] * p_over_q
voltage = 4e5
rf_omega = 1e9
t_phi0 = 0.1
a = 0.1

# sagan_cavity_thin!(i, coords::Coords, radiation_damping_on, 
#                                      mass, q, E0_ref, dE_ref,
#                                      t_ref, m_order, BnL, BsL, BsolL, a, q_voltage, rf_omega, t_phi0, L)

# sagan_cavity_thick!(i, coords::Coords, radiation_damping_on, traveling_wave, 
#              mass, q, E0_ref, dE_ref, t_ref, n_cell, m_order, Bn, Bs, Bsol, 
#              a, q_voltage, rf_omega, t_phi0, L_active, L)

@testset "SaganCavityKernel" begin
  args = (true, mass, q, E0, dE, t_ref, order, Bn*L, Bs*L, Bsol*L, a, q*voltage, rf_omega, t_phi0, L)
  bunch = Bunch(copy(vb1))
  BT.launch!(bunch.coords, KernelCall(BT.sagan_cavity_thin!, args))
  @test bunch.coords.v ≈ out1
  test_matrix(m1out, KernelCall(BT.sagan_cavity_thin!, args))

  args = (true, false, mass, q, E0, dE, t_ref, 2.0, order, Bn, Bs, Bsol, a, q*voltage, rf_omega, t_phi0, L/2, L)
  bunch = Bunch(copy(vb1))
  BT.launch!(bunch.coords, KernelCall(BT.sagan_cavity_thick!, args))
  @test bunch.coords.v ≈ out2
  # test_matrix(m2out, KernelCall(BT.sagan_cavity_thick!, args))
end